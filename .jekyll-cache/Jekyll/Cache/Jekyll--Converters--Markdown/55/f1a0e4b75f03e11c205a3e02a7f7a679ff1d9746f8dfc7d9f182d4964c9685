I"X†<p>ä¹‹å‰åœ¨ç½‘ä¸Šçœ‹åˆ°äº†ä¸€ç¯‡ä½¿ç”¨LSTMè¿›è¡Œæ—¶é—´åºåˆ—é¢„æµ‹çš„æ•™ç¨‹ï¼Œé‡‡ç”¨çš„æ˜¯Kerasæ¡†æ¶ï¼Œæœ¬æ–‡çš„ä¸»è¦å·¥ä½œæ˜¯å°è¯•ç†è§£è¿™æ•´ä¸ªè¿‡ç¨‹å¹¶æ”¹ç”¨PyTorchæ¡†æ¶é‡å†™ä¸€éã€‚åœ¨æ­¤ä¹‹å‰ï¼Œç¬”è€…åªå®‰è£…è¿‡TensorFlowå’ŒPyTorchçš„ç¼–ç¨‹ç¯å¢ƒï¼ˆè¿˜æ˜¯åŸºäºCPUçš„ï¼‰ï¼Œç„¶åè·‘è¿‡å®˜ç½‘ä¸Šä¸€ä¸¤ä¸ªGetting Startedä¹‹ç±»çš„Tutorialï¼Œå› æ­¤å¯ä»¥è¯´æ˜¯Start From Scratchäº†ã€‚</p>

<p>åŸæ–‡åœ¨æ­¤ï¼š<a href="http://machinelearningmastery.com/multivariate-time-series-forecasting-lstms-keras/">Multivariate Time Series Forecasting with LSTMs in Keras</a>ã€‚æ­¤å¤–ï¼Œè¿˜æœ‰ä¸€ç¯‡ç›¸å…³çš„æ–‡ç« ï¼Œä¹Ÿæ˜¯ç”¨Kerasåšçš„ï¼š<a href="http://www.jakob-aungiers.com/articles/a/LSTM-Neural-Network-for-Time-Series-Prediction">LSTM Neural Network for Time Series Prediction</a>, å¯ä»¥åœ¨Githubä¸Šçœ‹åˆ°<a href="https://github.com/jaungiers/LSTM-Neural-Network-for-Time-Series-Prediction">Source Code</a></p>

<p>ä¸‹é¢å¼€å§‹è§£å‰–æ•´ä¸ªè¿‡ç¨‹</p>

<h1 id="æ•°æ®å‡†å¤‡">æ•°æ®å‡†å¤‡</h1>
<p>é¦–å…ˆæ˜¯æ•°æ®å‡†å¤‡ï¼Œåœ¨åŸæ–‡ä¸­ï¼Œä½¿ç”¨çš„æ˜¯ç¯å¢ƒç›‘æµ‹çš„æ•°æ®é›†ï¼ŒåŒ…å«çš„å±æ€§ä¸»è¦æœ‰ï¼š</p>
<ul>
  <li>No: row number</li>
  <li>year: year of data in this row</li>
  <li>month: month of data in this row</li>
  <li>day: day of data in this row</li>
  <li>hour: hour of data in this row</li>
  <li>pm2.5: PM2.5 concentration</li>
  <li>DEWP: Dew Point</li>
  <li>TEMP: Temperature</li>
  <li>PRES: Pressure</li>
  <li>cbwd: Combined wind direction</li>
  <li>Iws: Cumulated wind speed</li>
  <li>Is: Cumulated hours of snow</li>
  <li>Ir: Cumulated hours of rain</li>
</ul>

<p>åŸæ¥çš„DataFrameé•¿è¿™æ ·</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">No</span><span class="p">,</span><span class="n">year</span><span class="p">,</span><span class="n">month</span><span class="p">,</span><span class="n">day</span><span class="p">,</span><span class="n">hour</span><span class="p">,</span><span class="n">pm2</span><span class="p">.</span><span class="mi">5</span><span class="p">,</span><span class="n">DEWP</span><span class="p">,</span><span class="n">TEMP</span><span class="p">,</span><span class="n">PRES</span><span class="p">,</span><span class="n">cbwd</span><span class="p">,</span><span class="n">Iws</span><span class="p">,</span><span class="n">Is</span><span class="p">,</span><span class="n">Ir</span>
<span class="mi">1</span><span class="p">,</span><span class="mi">2010</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">NA</span><span class="p">,</span><span class="o">-</span><span class="mi">21</span><span class="p">,</span><span class="o">-</span><span class="mi">11</span><span class="p">,</span><span class="mi">1021</span><span class="p">,</span><span class="n">NW</span><span class="p">,</span><span class="mf">1.79</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span>
<span class="mi">2</span><span class="p">,</span><span class="mi">2010</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">NA</span><span class="p">,</span><span class="o">-</span><span class="mi">21</span><span class="p">,</span><span class="o">-</span><span class="mi">12</span><span class="p">,</span><span class="mi">1020</span><span class="p">,</span><span class="n">NW</span><span class="p">,</span><span class="mf">4.92</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span>
<span class="err">â€¦â€¦</span>
</code></pre></div></div>
<p>å°†æ—¥æœŸæ•°æ®ç”¨pandasåˆå¹¶æˆä¸€åˆ—</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
	<span class="k">return</span> <span class="n">datetime</span><span class="p">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s">'%Y %m %d %H'</span><span class="p">)</span>
<span class="n">dataset</span> <span class="o">=</span> <span class="n">read_csv</span><span class="p">(</span><span class="s">'raw.csv'</span><span class="p">,</span>  <span class="n">parse_dates</span> <span class="o">=</span> <span class="p">[[</span><span class="s">'year'</span><span class="p">,</span> <span class="s">'month'</span><span class="p">,</span> <span class="s">'day'</span><span class="p">,</span> <span class="s">'hour'</span><span class="p">]],</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">date_parser</span><span class="o">=</span><span class="n">parse</span><span class="p">)</span>
</code></pre></div></div>
<p>å¾—åˆ°æ–°çš„DataFrame</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">date</span><span class="p">,</span><span class="n">pollution</span><span class="p">,</span><span class="n">dew</span><span class="p">,</span><span class="n">temp</span><span class="p">,</span><span class="n">press</span><span class="p">,</span><span class="n">wnd_dir</span><span class="p">,</span><span class="n">wnd_spd</span><span class="p">,</span><span class="n">snow</span><span class="p">,</span><span class="n">rain</span>
<span class="mi">2010</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">02</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span><span class="mf">129.0</span><span class="p">,</span><span class="o">-</span><span class="mi">16</span><span class="p">,</span><span class="o">-</span><span class="mf">4.0</span><span class="p">,</span><span class="mf">1020.0</span><span class="p">,</span><span class="n">SE</span><span class="p">,</span><span class="mf">1.79</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span>
<span class="mi">2010</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">02</span> <span class="mi">01</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span><span class="mf">148.0</span><span class="p">,</span><span class="o">-</span><span class="mi">15</span><span class="p">,</span><span class="o">-</span><span class="mf">4.0</span><span class="p">,</span><span class="mf">1020.0</span><span class="p">,</span><span class="n">SE</span><span class="p">,</span><span class="mf">2.68</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span>
<span class="mi">2010</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">02</span> <span class="mi">02</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span><span class="mf">159.0</span><span class="p">,</span><span class="o">-</span><span class="mi">11</span><span class="p">,</span><span class="o">-</span><span class="mf">5.0</span><span class="p">,</span><span class="mf">1021.0</span><span class="p">,</span><span class="n">SE</span><span class="p">,</span><span class="mf">3.57</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span>
<span class="mi">2010</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">02</span> <span class="mi">03</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span><span class="mf">181.0</span><span class="p">,</span><span class="o">-</span><span class="mi">7</span><span class="p">,</span><span class="o">-</span><span class="mf">5.0</span><span class="p">,</span><span class="mf">1022.0</span><span class="p">,</span><span class="n">SE</span><span class="p">,</span><span class="mf">5.36</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span>
<span class="mi">2010</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">02</span> <span class="mi">04</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span><span class="mf">138.0</span><span class="p">,</span><span class="o">-</span><span class="mi">7</span><span class="p">,</span><span class="o">-</span><span class="mf">5.0</span><span class="p">,</span><span class="mf">1022.0</span><span class="p">,</span><span class="n">SE</span><span class="p">,</span><span class="mf">6.25</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span>
<span class="err">â€¦â€¦</span>
</code></pre></div></div>

<p>æ¥ä¸‹æ¥éœ€è¦åšçš„å·¥ä½œæ˜¯æŠŠæ—¶é—´åºåˆ—æ•°æ®è½¬åŒ–ä¸ºå¯ä»¥è¿›è¡Œç›‘ç£å­¦ä¹ çš„æ•°æ®ï¼Œå‚è§<a href="http://machinelearningmastery.com/convert-time-series-supervised-learning-problem-python/">è¿™ç¯‡æ–‡ç« </a>ã€‚</p>

<p>ä¸‹é¢æ˜¯ä»£ç ï¼Œå®šä¹‰äº†ä¸€ä¸ªå‡½æ•°series_to_supervisedï¼Œç”¨æ¥æŠŠåŸæ¥çš„æ—¶é—´åºåˆ—æ•°æ®è½¬åŒ–æˆç›‘ç£å­¦ä¹ çš„æ•°æ®é›†ã€‚åœ¨è°ƒç”¨è¿™ä¸ªå‡½æ•°ä¹‹å‰ï¼Œç”¨Sci-kit Learnä¸­çš„ä¸¤ä¸ªç±»è¿›è¡Œäº†æ•°æ®é¢„å¤„ç†ï¼Œå…ˆæ˜¯ç”¨LabelEncoderæŠŠæ•°æ®ä¸­éæ•°å€¼ç‰¹å¾ï¼ˆé£å‘-wnd_dirï¼‰è½¬åŒ–æˆäº†ä»0å¼€å§‹çš„æ•°å€¼ç‰¹å¾ï¼Œç„¶åç”¨MinMaxScalerå¯¹æ•´ä¸ªæ•°æ®é›†è¿›è¡Œäº†æ ‡å‡†åŒ–ã€‚</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># convert series to supervised learning
</span><span class="k">def</span> <span class="nf">series_to_supervised</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">n_in</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_out</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">dropnan</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
	<span class="n">n_vars</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span> <span class="k">else</span> <span class="n">data</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
	<span class="n">df</span> <span class="o">=</span> <span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
	<span class="n">cols</span><span class="p">,</span> <span class="n">names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(),</span> <span class="nb">list</span><span class="p">()</span>
	<span class="c1"># input sequence (t-n, ... t-1)
</span>	<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_in</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
		<span class="n">cols</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">.</span><span class="n">shift</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
		<span class="n">names</span> <span class="o">+=</span> <span class="p">[(</span><span class="s">'var%d(t-%d)'</span> <span class="o">%</span> <span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_vars</span><span class="p">)]</span>
	<span class="c1"># forecast sequence (t, t+1, ... t+n)
</span>	<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_out</span><span class="p">):</span>
		<span class="n">cols</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="n">i</span><span class="p">))</span>
		<span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
			<span class="n">names</span> <span class="o">+=</span> <span class="p">[(</span><span class="s">'var%d(t)'</span> <span class="o">%</span> <span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_vars</span><span class="p">)]</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">names</span> <span class="o">+=</span> <span class="p">[(</span><span class="s">'var%d(t+%d)'</span> <span class="o">%</span> <span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_vars</span><span class="p">)]</span>
	<span class="c1"># put it all together
</span>	<span class="n">agg</span> <span class="o">=</span> <span class="n">concat</span><span class="p">(</span><span class="n">cols</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
	<span class="n">agg</span><span class="p">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">names</span>
	<span class="c1"># drop rows with NaN values
</span>	<span class="k">if</span> <span class="n">dropnan</span><span class="p">:</span>
		<span class="n">agg</span><span class="p">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
	<span class="k">return</span> <span class="n">agg</span>

<span class="c1"># load dataset
</span><span class="n">values</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">.</span><span class="n">values</span>
<span class="c1"># integer encode direction
</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">MinMaxScaler</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">LabelEncoder</span>

<span class="n">encoder</span> <span class="o">=</span> <span class="n">LabelEncoder</span><span class="p">()</span>
<span class="n">values</span><span class="p">[:,</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">encoder</span><span class="p">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">values</span><span class="p">[:,</span><span class="mi">4</span><span class="p">])</span>
<span class="c1"># ensure all data is float
</span><span class="n">values</span> <span class="o">=</span> <span class="n">values</span><span class="p">.</span><span class="n">astype</span><span class="p">(</span><span class="s">'float32'</span><span class="p">)</span>
<span class="c1"># normalize features
</span><span class="n">scaler</span> <span class="o">=</span> <span class="n">MinMaxScaler</span><span class="p">(</span><span class="n">feature_range</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">scaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="p">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>

<span class="c1"># frame as supervised learning
</span><span class="n">reframed</span> <span class="o">=</span> <span class="n">series_to_supervised</span><span class="p">(</span><span class="n">scaled</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="c1"># drop columns we don't want to predict
</span><span class="n">reframed</span><span class="p">.</span><span class="n">drop</span><span class="p">(</span><span class="n">reframed</span><span class="p">.</span><span class="n">columns</span><span class="p">[[</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">14</span><span class="p">,</span><span class="mi">15</span><span class="p">]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">reframed</span><span class="p">.</span><span class="n">head</span><span class="p">())</span>
</code></pre></div></div>

<p>è¿™æ ·å¯ä»¥å¾—åˆ°çš„DataFrameé•¿è¿™æ ·ï¼Œä¸€å…±æ˜¯8ä¸ªç‰¹å¾ï¼Œä½œä¸ºXï¼Œé¢„æµ‹å€¼Yæ˜¯å…¶ä¸­çš„ç¬¬ä¸€ä¸ªç‰¹å¾ï¼Œå³pm2.5çš„æ±¡æŸ“é‡ï¼Œå› ä¸ºæ˜¯é¢„æµ‹æ—¶é—´åºåˆ—æ•°æ®ï¼Œæ‰€ä»¥Yå¯ä»¥æ˜¯Xä¸­çš„æŸä¸€ä¸ªç‰¹å¾ï¼Œåªä¸è¿‡æ˜¯åˆ©ç”¨t-1æ—¶åˆ»çš„å€¼é¢„æµ‹tæ—¶åˆ»çš„å€¼ã€‚</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   <span class="n">var1</span><span class="p">(</span><span class="n">t</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>  <span class="n">var2</span><span class="p">(</span><span class="n">t</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>  <span class="n">var3</span><span class="p">(</span><span class="n">t</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>  <span class="n">var4</span><span class="p">(</span><span class="n">t</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>  <span class="n">var5</span><span class="p">(</span><span class="n">t</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>  <span class="n">var6</span><span class="p">(</span><span class="n">t</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>  \
<span class="mi">1</span>   <span class="mf">0.129779</span>   <span class="mf">0.352941</span>   <span class="mf">0.245902</span>   <span class="mf">0.527273</span>   <span class="mf">0.666667</span>   <span class="mf">0.002290</span>
<span class="mi">2</span>   <span class="mf">0.148893</span>   <span class="mf">0.367647</span>   <span class="mf">0.245902</span>   <span class="mf">0.527273</span>   <span class="mf">0.666667</span>   <span class="mf">0.003811</span>
<span class="mi">3</span>   <span class="mf">0.159960</span>   <span class="mf">0.426471</span>   <span class="mf">0.229508</span>   <span class="mf">0.545454</span>   <span class="mf">0.666667</span>   <span class="mf">0.005332</span>
<span class="mi">4</span>   <span class="mf">0.182093</span>   <span class="mf">0.485294</span>   <span class="mf">0.229508</span>   <span class="mf">0.563637</span>   <span class="mf">0.666667</span>   <span class="mf">0.008391</span>
<span class="mi">5</span>   <span class="mf">0.138833</span>   <span class="mf">0.485294</span>   <span class="mf">0.229508</span>   <span class="mf">0.563637</span>   <span class="mf">0.666667</span>   <span class="mf">0.009912</span>

   <span class="n">var7</span><span class="p">(</span><span class="n">t</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>  <span class="n">var8</span><span class="p">(</span><span class="n">t</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>   <span class="n">var1</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
<span class="mi">1</span>   <span class="mf">0.000000</span>        <span class="mf">0.0</span>  <span class="mf">0.148893</span>
<span class="mi">2</span>   <span class="mf">0.000000</span>        <span class="mf">0.0</span>  <span class="mf">0.159960</span>
<span class="mi">3</span>   <span class="mf">0.000000</span>        <span class="mf">0.0</span>  <span class="mf">0.182093</span>
<span class="mi">4</span>   <span class="mf">0.037037</span>        <span class="mf">0.0</span>  <span class="mf">0.138833</span>
<span class="mi">5</span>   <span class="mf">0.074074</span>        <span class="mf">0.0</span>  <span class="mf">0.109658</span>
</code></pre></div></div>

<h1 id="æ„å»ºlstmç½‘ç»œ">æ„å»ºLSTMç½‘ç»œ</h1>

<p>å…³äºLSTMæ¨¡å‹çš„ä»‹ç»å¯ä»¥å‚è€ƒè¿™ç¯‡ï¼š<a href="http://www.jianshu.com/p/9dc9f41f0b29">ç†è§£LSTMç½‘ç»œ(è¯‘)</a></p>

<p>åœ¨LSTMæ¨¡å‹ä¸­ï¼Œæ¯ä¸ªcelléƒ½åŒ…å«ä¸€ä¸ªhidden stateå’Œä¸€ä¸ªcell stateï¼Œåˆ†åˆ«è®°ä¸ºhå’Œcï¼Œå¯¹åº”äºè¿™ä¸ªcellçš„è¾“å…¥ï¼Œåœ¨cellä¸­é€šè¿‡å®šä¹‰ä¸€ç³»åˆ—çš„å‡½æ•°ï¼Œæœ‰ç‚¹ç±»ä¼¼äºæ•°å­—ç”µè·¯ä¸­çš„â€œé—¨â€çš„æ¦‚å¿µï¼Œä»è€Œå®ç°ä¸€äº›è¯¸å¦‚â€œé—å¿˜â€çš„åŠŸèƒ½ã€‚è¿™äº›å…·ä½“çš„å‡½æ•°å·²ç»è¢«PyTorchç­‰æ·±åº¦å­¦ä¹ æ¡†æ¶å°è£…å¥½äº†ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦åšçš„å°±æ˜¯å®šä¹‰hå’Œcã€‚åœ¨åŸæ–‡ä¸­ï¼Œä½œè€…ä½¿ç”¨äº†Kerasè¿›è¡Œç¥ç»ç½‘ç»œçš„æ­å»ºï¼Œä»–æŠŠéšå±‚å®šä¹‰ä¸º50ä¸ªç¥ç»å…ƒï¼ˆæˆ‘çš„ç†è§£å…¶å®å°±æ˜¯è¯´hidden stateåŒ…å«æœ‰50ä¸ªfeatureï¼‰ï¼Œåœ¨è¿™ä¹‹ååˆæ¥äº†ä¸€ä¸ªDenseå±‚ï¼Œè¿™åº”è¯¥æ˜¯ä¸ºäº†æŠŠéšå±‚çš„è®¡ç®—ç»“æœæ˜ å°„å‡ºä¸€ä¸ªoutputå€¼ã€‚</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># design network
</span><span class="n">model</span> <span class="o">=</span> <span class="n">Sequential</span><span class="p">()</span>
<span class="n">model</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">LSTM</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="n">train_X</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">train_X</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])))</span>
<span class="n">model</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
</code></pre></div></div>

<p>åœ¨PyTorchä¸­ï¼Œé‡‡ç”¨å¦‚ä¸‹çš„æ–¹æ³•å®šä¹‰è¿™ä¸ªç½‘ç»œã€‚å»ºç«‹ä¸€ä¸ªæœ‰ä¸¤ä¸ªLSTMCellæ„æˆçš„Sequenceç½‘ç»œï¼Œç„¶åç»™å®šåˆå§‹åŒ–çš„h0å’Œc0ï¼ŒæŠŠè¾“å…¥å’Œè¾“å‡ºå–‚ç»™è¿™ä¸¤ä¸ªcellå³å¯ã€‚</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Sequence</span><span class="p">(</span><span class="n">nn</span><span class="p">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Sequence</span><span class="p">,</span> <span class="bp">self</span><span class="p">).</span><span class="n">__init__</span><span class="p">()</span>
        <span class="c1"># the hidden_size is 51
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">lstm1</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="n">LSTMCell</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">51</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">lstm2</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="n">LSTMCell</span><span class="p">(</span><span class="mi">51</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">,</span> <span class="n">future</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># both the input(h_t, c_t) and output(h_t2, c_t2) are initialized to zeros
</span>        <span class="n">h_t</span> <span class="o">=</span> <span class="n">Variable</span><span class="p">(</span>
            <span class="n">torch</span><span class="p">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">input</span><span class="p">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="mi">51</span><span class="p">),</span> <span class="n">requires_grad</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">c_t</span> <span class="o">=</span> <span class="n">Variable</span><span class="p">(</span>
            <span class="n">torch</span><span class="p">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">input</span><span class="p">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="mi">51</span><span class="p">),</span> <span class="n">requires_grad</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">h_t2</span> <span class="o">=</span> <span class="n">Variable</span><span class="p">(</span>
            <span class="n">torch</span><span class="p">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">input</span><span class="p">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="mi">1</span><span class="p">),</span> <span class="n">requires_grad</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">c_t2</span> <span class="o">=</span> <span class="n">Variable</span><span class="p">(</span>
            <span class="n">torch</span><span class="p">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">input</span><span class="p">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="mi">1</span><span class="p">),</span> <span class="n">requires_grad</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">input_t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">input</span><span class="p">.</span><span class="n">chunk</span><span class="p">(</span><span class="nb">input</span><span class="p">.</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)):</span>
            <span class="n">h_t</span><span class="p">,</span> <span class="n">c_t</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">lstm1</span><span class="p">(</span><span class="n">input_t</span><span class="p">,</span> <span class="p">(</span><span class="n">h_t</span><span class="p">,</span> <span class="n">c_t</span><span class="p">))</span>
            <span class="n">h_t2</span><span class="p">,</span> <span class="n">c_t2</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">lstm2</span><span class="p">(</span><span class="n">c_t</span><span class="p">,</span> <span class="p">(</span><span class="n">h_t2</span><span class="p">,</span> <span class="n">c_t2</span><span class="p">))</span>
            <span class="n">outputs</span> <span class="o">+=</span> <span class="p">[</span><span class="n">c_t2</span><span class="p">]</span>

        <span class="n">outputs</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">stack</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="mi">1</span><span class="p">).</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">outputs</span>
</code></pre></div></div>

<p>è¿™é‡Œå‚è€ƒäº†ä»¥ä¸‹ä¸‰ç¯‡æ–‡æ¡£ï¼š</p>
<ul>
  <li>https://github.com/pytorch/examples/tree/master/time_sequence_prediction</li>
  <li>http://pytorch.org/docs/master/nn.html#lstm</li>
  <li>http://pytorch.org/tutorials/beginner/nlp/sequence_models_tutorial.html</li>
</ul>

<h1 id="æ¨¡å‹è®­ç»ƒ">æ¨¡å‹è®­ç»ƒ</h1>

<p>è®­ç»ƒè¿™æ ·ä¸€ä¸ªç½‘ç»œï¼Œéœ€è¦å®šä¹‰ç›¸åº”çš„æŸå¤±å‡½æ•°loss functionå’Œä¼˜åŒ–ç®—æ³•ï¼Œç„¶åå°±å¯ä»¥å¥—ä¸€ä¸‹ä»£ç çš„æ¨¡æ¿è¿›è¡Œè®­ç»ƒäº†ã€‚</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># build the model
</span><span class="n">seq</span> <span class="o">=</span> <span class="n">Sequence</span><span class="p">()</span>
<span class="n">criterion</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="n">MSELoss</span><span class="p">()</span>
<span class="c1"># use LBFGS as optimizer since we can load the whole data to train
</span><span class="n">optimizer</span> <span class="o">=</span> <span class="n">optim</span><span class="p">.</span><span class="n">LBFGS</span><span class="p">(</span><span class="n">seq</span><span class="p">.</span><span class="n">parameters</span><span class="p">())</span>

<span class="n">loss_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">test_loss_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">epoch_num</span> <span class="o">=</span> <span class="mi">50</span>

<span class="c1"># begin to train
</span><span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">epoch_num</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'epoch : '</span><span class="p">,</span> <span class="n">epoch</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">closure</span><span class="p">():</span>
        <span class="n">optimizer</span><span class="p">.</span><span class="n">zero_grad</span><span class="p">()</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">seq</span><span class="p">(</span><span class="n">train_X</span><span class="p">)</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">criterion</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">train_y</span><span class="p">)</span>
<span class="c1">#         print('loss:', loss.data.numpy()[0])
</span>        <span class="n">loss_list</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">numpy</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">loss</span><span class="p">.</span><span class="n">backward</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">loss</span>

    <span class="n">optimizer</span><span class="p">.</span><span class="n">step</span><span class="p">(</span><span class="n">closure</span><span class="p">)</span>

    <span class="n">pred</span> <span class="o">=</span> <span class="n">seq</span><span class="p">(</span><span class="n">test_X</span><span class="p">)</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="n">criterion</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="n">test_y</span><span class="p">)</span>
<span class="c1">#     print('test loss:', loss.data.numpy()[0])
</span>    <span class="n">test_loss_list</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">numpy</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>

    <span class="n">y</span> <span class="o">=</span> <span class="n">pred</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">numpy</span><span class="p">()</span>
</code></pre></div></div>

<p>è¯¦ç»†ä»£ç å‚è§<a href="http://nbviewer.jupyter.org/github/zhicongchen/ml-beginners/blob/master/Multivariate%20Time%20Series%20Forecasting%20with%20LSTMs%20in%20PyTorch.ipynb">è¿™é‡Œ</a>ã€‚</p>
:ET